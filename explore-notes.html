<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Notes - Uloom-e-Shariyah</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
         /* --- Search Bar & Animations --- */
        .search-wrapper {
          order: 2;
            background-color: white; border-radius: 30px; border: 3px solid #ddd;
            overflow: hidden; transition: 0.3s; position: relative;
            width: 90%;
       max-width: 600px; margin: 10px auto;
        }
        .search-box { background-color: white !important; display: flex; align-items: center; border-radius: 28px; }
        .box { background-color: white !important; border: none; outline: none; padding: 12px 15px; width: 100%; font-size: 16px; }

        /* Animation Fixed */
        .search-wrapper.is-animating {
            border-color: transparent;
            background: linear-gradient(#fff, #fff) padding-box, 
                        linear-gradient(90deg, #81d4fa, #fff59d, #ad1457, #c8e6c9) border-box;
            background-clip: padding-box, border-box;
            background-size: 100% 100%, 400% 100%; 
            animation: slideColors 2s linear infinite;
        }
        @keyframes slideColors { from { background-position: 0% 0%, 0% 0%; } to { background-position: 0% 0%, 100% 0%; } }   

        /* Image Display Fix */
        .note-card img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .notes-container { padding: 40px 20px; width: 95%; max-width: 1600px; margin: auto; }
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }

        .note-card {
            background: #fff; border-radius: 15px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); border-top: 5px solid #d4af37;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: 0.3s ease;
        }
        .note-card:hover { transform: translateY(-5px); }

        .uploader-info { font-size: 12px; color: #95a5a6; display: flex; align-items: center; gap: 4px; margin-top: 8px; }
        #noResultsMessage { display: none; text-align: center; grid-column: 1 / -1; padding: 50px; color: #7f8c8d; }

        .filter-section { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 25px 0; }
        .filter-btn { 
            background: white; border: 2px solid #d4af37; color: #2c3e50; 
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        .filter-btn.active { background: #d4af37; color: white; }

        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-btn {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            padding: 12px; border-radius: 8px; text-decoration: none; font-size: 14px;
            font-weight: 600; cursor: pointer; border: none;
        }
        .view-btn { background: #3498db; color: white; }
        .download-btn { background: #27ae60; color: white; }
        .save-btn { background: #f1c40f; color: #2c3e50; grid-column: 1 / span 2; }
        .navbar { position: sticky; top: 0; z-index: 1000; }
  /* --- Dark Mode Variables --- */
:root {
    --bg-color: #f4f4f4;
    --card-bg: #ffffff;
    --text-color: #2c3e50;
    --border-color: #ddd;
    --top-bg: #ffffff;
}

[data-theme="dark"] {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #ffff;
    --border-color: #333;
    --top-bg: #1e1e1e;
}

body { 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    transition: 0.3s; 
    margin: 0;
    display: flex;
    flex-direction: column;
}

/* Elements par variables apply karein */
.top { 
    background-color: var(--top-bg); 
    color: var(--text-color);
    margin: 0 0;
    padding: 5px 0;
    text-align: center;
    font-weight: bold;
}

.search-wrapper {
    background-color: var(--card-bg); /* Dark mode mein wrapper bhi dark hoga */
    border-color: var(--border-color);
}

.search-box, .box {
    background-color: var(--card-bg) !important;
    color: var(--text-color) !important;
}

.note-card {
    background: var(--card-bg);
    color: var(--text-color);
}

/* Floating Toggle Button Style */
.theme-switch {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #d4af37;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 1001;
    border: none;
}

    </style>
</head>
<body>

  <p style="order: 1;" class="top">Uloom-e-Shariyah</p>
  
      <div class="search-wrapper" id="searchWrapper">
        <div class="search-box">
          <input type="text" placeholder="Search by subject, title or class..." class="box" id="mainSearchInput">
          <span class="material-symbols-outlined" id="search">search</span> 
        </div> 
      </div>

  <div style="order: 3;" class="notes-container">
    <h2 id="currentCategoryTitle" style="text-align: center; color: #2c3e50; margin-bottom: 10px;">Loading Sacred Notes...</h2>
    
    <div style="order: 4;" class="filter-section">
        <button class="filter-btn active" onclick="filterBySubject('all', this)">All</button>
        <button class="filter-btn" onclick="filterBySubject('Taharah', this)">Taharah</button>
        <button class="filter-btn" onclick="filterBySubject('Tafseer', this)">Tafseer</button>
        <button class="filter-btn" onclick="filterBySubject('Aqeedah', this)">Aqeedah</button>
        <button class="filter-btn" onclick="filterBySubject('Salaat', this)">Salaat</button>
        <button class="filter-btn" onclick="filterBySubject('Nabi', this)">Sirat</button>
    </div>

    <div style="order: 5;" id="notesList" class="notes-grid">
        <p id="loadingMsg" style="text-align: center; grid-column: 1/-1;">Connecting to library...</p>
        <div id="noResultsMessage">
            <span class="material-symbols-outlined" style="font-size: 48px;">search_off</span>
            <p>No notes found for your level in this category.</p>
        </div>
    </div>
  </div>

<button class="theme-switch" id="themeToggle">
    <span class="material-symbols-outlined" id="themeIcon">dark_mode</span>
</button>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { 
    apiKey: "AIzaSyB_MCKP6SPKloZpf_pHZBzy2vvkiJ3B7gk",
    authDomain: "uloom-e-shariah.firebaseapp.com",
    projectId: "uloom-e-shariah",
    storageBucket: "uloom-e-shariah.firebasestorage.app",
    messagingSenderId: "210360115259",
    appId: "1:210360115259:web:938d886285f4412d3ebc1e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- AUTH CHECK ---
const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
if (!loggedInUser) {
    window.location.href = "login.html";
}
const userLevel = loggedInUser.level;
document.getElementById('currentCategoryTitle').innerText = `Sacred Notes - Level ${userLevel}`;

// --- FETCH DATA ---
async function fetchNotes() {
    const notesList = document.getElementById('notesList');
    try {
        const q = query(collection(db, "notes"), where("level", "==", parseInt(userLevel)));
        const querySnapshot = await getDocs(q);
        
        const loadingElement = document.getElementById('loadingMsg');
        if(loadingElement) loadingElement.remove();

        if (querySnapshot.empty) {
            document.getElementById('noResultsMessage').style.display = "block";
            return;
        }

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const card = document.createElement('div');
            card.className = 'note-card';
            
            // Normalize values for search
            let sub = (data.subject || 'General').toLowerCase().replace('slaat', 'salaat');
            let title = (data.title || '').toLowerCase();
            let className = (data.className || '').toLowerCase();
            
            // Set attributes for multi-field filtering
            card.setAttribute('data-subject', sub);
            card.setAttribute('data-title', title);
            card.setAttribute('data-class', className);
        
            card.innerHTML = `
                <div>
                    <span class="subject-tag" style="background: #f1c40f22; color: #b8860b; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                        ${data.subject || 'General'}
                    </span>
                    <h3 style="margin-top:15px; color:#2c3e50; font-size: 1.2rem;">${data.title || 'Untitled'}</h3>
                    <p style="font-size:13px; color:#7f8c8d; margin-top:5px;"><strong>Class:</strong> ${data.className || 'N/A'}</p>
                    <div class="uploader-info">
                        <span class="material-symbols-outlined" style="font-size:14px;">person</span>
                        <span>By: ${data.uploaderName || 'Admin'}</span>
                    </div>
                </div>
                <div class="card-actions">
                    <a href="${data.fileUrl}" target="_blank" class="action-btn view-btn"><span class="material-symbols-outlined">visibility</span>View</a>
                    <a href="${data.fileUrl}" download class="action-btn download-btn"><span class="material-symbols-outlined">download</span>Download</a>
                    <button onclick="saveNote('${doc.id}', '${data.title}', '${data.fileUrl}')" class="action-btn save-btn"><span class="material-symbols-outlined">bookmark</span>Save to Profile</button>
                </div>
            `;
            notesList.appendChild(card);
        });
    } catch (e) { console.error(e); }
}

// Filter Section ko empty rakhein HTML mein aur id dein: id="filterSection"
const filterSection = document.querySelector('.filter-section');

const levelSubjects = {
    "1": ["Taharah", "Tafseer", "Aqeedah", "Salaat", "Nabi"],
    "2": ["Tauheed", "Tafseer", "Ibadat", "Dawat Ila Allah"],
    "3": ["Ikhlaq o Adaab", "Eman o Aqaid", "Hadith", "Tafseer", "Nikah wat Talaaq", "Ilhad", "Usool Al Fiqh", "Kitabul Buyoo"]
};

function generateFilters() {
    const userLevelStr = String(userLevel); // userLevel already upar define hai
    const subjects = levelSubjects[userLevelStr] || [];
    
    filterSection.innerHTML = `<button class="filter-btn active" onclick="filterBySubject('all', this)">All</button>`;
    
    subjects.forEach(sub => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.innerText = sub;
        btn.onclick = (e) => filterBySubject(sub, e.target);
        filterSection.appendChild(btn);
    });
}

// fetchNotes() call karne se pehle ise call karein
generateFilters();


// --- GLOBAL FUNCTIONS (WINDOW) ---
window.filterBySubject = function(sub, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const filterSub = sub.toLowerCase();
    let visibleCount = 0;
    
    document.querySelectorAll('.note-card').forEach(card => {
        const cardSub = card.getAttribute('data-subject');
        if (filterSub === 'all' || cardSub.includes(filterSub)) {
            card.style.display = "flex";
            visibleCount++;
        } else {
            card.style.display = "none";
        }
    });
    document.getElementById('noResultsMessage').style.display = visibleCount === 0 ? "block" : "none";
}

window.saveNote = async (id, title, url) => {
    try {
        await addDoc(collection(db, "saved_notes"), { 
            userEmail: loggedInUser.email, 
            noteId: id, title, fileUrl: url, 
            timestamp: serverTimestamp() 
        });
        alert("Saved to profile!");
    } catch (e) { alert("Error saving."); }
}

// Search Logic: Title, Subject, and Class Name teeno check karega
const searchInput = document.getElementById('mainSearchInput');
const searchWrapper = document.getElementById('searchWrapper');

searchInput.addEventListener('input', () => {
    let val = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;
    
    document.querySelectorAll('.note-card').forEach(card => {
        const title = card.getAttribute('data-title');
        const subject = card.getAttribute('data-subject');
        const className = card.getAttribute('data-class');
        
        // Teeno strings ko combine karke search karein
        const combinedData = `${title} ${subject} ${className}`;
        
        if (combinedData.includes(val)) {
            card.style.display = "flex";
            visibleCount++;
        } else {
            card.style.display = "none";
        }
    });
    document.getElementById('noResultsMessage').style.display = visibleCount === 0 ? "block" : "none";
});

searchInput.addEventListener('focus', () => searchWrapper.classList.add('is-animating'));
searchInput.addEventListener('blur', () => searchWrapper.classList.remove('is-animating'));

fetchNotes();

// --- DARK MODE TOGGLE LOGIC ---
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const currentTheme = localStorage.getItem('theme') || 'light';

// Page load par theme apply karein
if (currentTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.innerText = 'light_mode';
}

themeToggle.addEventListener('click', () => {
    let theme = document.documentElement.getAttribute('data-theme');
    
    if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        themeIcon.innerText = 'dark_mode';
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        themeIcon.innerText = 'light_mode';
    }
});

</script>
</body>
</html>
