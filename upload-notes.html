<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Notes - Uloom-e-Shariyah</title>
    <link rel="stylesheet" href="auth-style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
    /* --- Dark Mode Variables --- */
    :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --text-color: #2c3e50;
        --border-color: #ddd;
        --input-bg: #f8f9fa;
        --dashed-border: #d4af37;
    }

    [data-theme="dark"] {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #333;
        --input-bg: #2d2d2d;
        --dashed-border: #d4af37;
    }

    body { 
        background-color: var(--bg-color); 
        color: var(--text-color); 
        transition: 0.3s; 
        margin: 0;
    }

    /* General Fixes */
    .input-group input, .input-group select {
        width: 100% !important;
        border: none !important;
        outline: none !important;
        background: transparent !important;
        color: var(--text-color) !important;
    }

    .input-group {
        background-color: var(--input-bg) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 8px;
        padding: 10px;
    }

    .auth-container {
        width: 100% !important;
        max-width: 100% !important;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
    }

    .auth-box {
        width: 100%;
        max-width: 500px;
        background: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        transition: 0.3s;
    }

    h2 { color: var(--text-color); }

    /* File Input Styling */
    .file-input-field {
        grid-column: span 2;
        text-align: center !important;
        margin-top: 10px;
    }

    #noteFile {
        display: block;
        margin: 10px auto;
        width: 100%;
        max-width: 550px;
        padding: 20px;
        border: 2px dashed var(--dashed-border);
        background: var(--input-bg);
        color: var(--text-color);
        cursor: pointer;
        text-align: center;
        border-radius: 10px;
    }

    /* Floating Theme Switch */
    .theme-switch {
        position: fixed; bottom: 25px; right: 25px;
        background: none; color: var(--text-color); width: 50px; height: 50px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; border: none;
    }

    /* --- DESKTOP VIEW --- */
    @media (min-width: 769px) {
        .auth-box {
            max-width: 900px !important;
            padding: 50px !important;
        }

        #uploadForm {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 30px;
            text-align: left;
        }

        .logo, h2, .auth-btn, #progressContainer, .file-input-field {
            grid-column: span 2;
        }

        h2 { font-size: 30px; margin-bottom: 35px; }

        .auth-btn {
            padding: 15px;
            font-size: 18px;
            margin-top: 20px;
            background: #d4af37;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
    }

    .input-field { text-align: left; margin-bottom: 15px; }
    .input-field label { display: block; margin-bottom: 5px; font-weight: 600; }
</style>

</head>
<body>
  
<div class="auth-container">
    <div class="auth-box">
        <div class="logo">
            <img src="logo.png" alt="Uloom-e-Shariah" height="150px">
        </div>      
        <h2>Upload Your Notes</h2>
        <form id="uploadForm">
            
            <div class="input-field">
                <label for="targetLevel">Target Level</label>
                <div class="input-group">
                    <select id="targetLevel" required>
                        <option value="" disabled selected>Select student level</option>
                        <option value="1">Level 1 (Basic)</option>
                        <option value="2">Level 2 (Intermediate)</option>
                        <option value="3">Level 3 (Advanced)</option>
                    </select>
                </div>
            </div>

            <div class="input-field">
                <label for="noteSubject">Select Subject</label>
                <div class="input-group">
                    <select id="noteSubject" required>
                        <option value="" disabled selected>Choose a subject</option>
                        <option value="Taharah">Kitab-ut-Taharah</option>
                        <option value="Tafseer">Tafseer-ul-Quran</option>
                        <option value="Aqeedah">Aqeedah-o-Manhaj</option>
                        <option value="Salaat">Kitab-us-Salaat</option>
                        <option value="Nabi">Sirat-un-Nabi</option>
                    </select>
                </div>
            </div>

            <div class="input-field">
                <label for="noteTitle">Note Title</label>
                <div class="input-group">
                    <input type="text" id="noteTitle" placeholder="e.g. Summary of Class" required>
                </div>
            </div>

            <div class="input-field">
                <label for="className">Class Name</label>
                <div class="input-group">
                    <input type="text" id="className" placeholder="e.g. Kitab-Ut-Taharah class 01" required>
                </div>
            </div>

            <div class="input-field file-input-field">
                <label for="noteFile">Attach File (PDF/Image)</label>
                <input type="file" id="noteFile" accept="*/*" required>
            </div>

            <button type="submit" id="uploadBtn" class="auth-btn">Upload to Cloud</button>

            <div id="progressContainer" style="display:none; margin-top: 15px;">
                <progress id="uploadProgress" value="0" max="100" style="width: 100%;"></progress>
                <p id="percentText" style="text-align: center; font-size: 12px; font-weight: bold; color: #d4af37;">0%</p>
            </div>
        </form>
    </div>
</div>

<button class="theme-switch" id="themeToggle">
    <span class="material-symbols-outlined" id="themeIcon">dark_mode</span>
</button>

<script type="module">
// Firebase Logic
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { 
    apiKey: "AIzaSyB_MCKP6SPKloZpf_pHZBzy2vvkiJ3B7gk",
    authDomain: "uloom-e-shariah.firebaseapp.com",
    projectId: "uloom-e-shariah",
    storageBucket: "uloom-e-shariah.firebasestorage.app",
    messagingSenderId: "210360115259",
    appId: "1:210360115259:web:938d886285f4412d3ebc1e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const db = getFirestore(app);

// Subjects Data
const subjectsByLevel = {
    "1": [
        { val: "Taharah", text: "Kitab-ut-Taharah" },
        { val: "Tafseer", text: "Tafseer-ul-Quran" },
        { val: "Aqeedah", text: "Aqeedah-o-Manhaj" },
        { val: "Salaat", text: "Kitab-us-Salaat" },
        { val: "Nabi", text: "Sirat-un-Nabi" }
    ],
    "2": [
        { val: "Tauheed", text: "Aqeedah - Kitab At Tauheed" },
        { val: "Tafseer", text: "Tafseer Modouee" },
        { val: "Ibadat", text: "Fiqh ul Ibadat" },
        { val: "Dawat Ila Allah", text: "Dawat Ila Allah" }
    ],
    "3": [
        { val: "Ikhlaq o Adaab", text: "Ikhlaq o Adaab" },      
        { val: "Eman o Aqaid", text: "Eman o Aqaid se Mutaliqa Shubuhaat" },
        { val: "Hadith", text: "Mustalah Ul Hadith (Mukhtasar)" },
        { val: "Tafseer", text: "Usool At Tafseer" },
        { val: "Nikah wat Talaaq", text: "Fiqh - Kitabun Nikah wat Talaaq" },
        { val: "Ilhad", text: "Ilhad (atheism)" },
        { val: "Usool Al Fiqh", text: "Usool Al Fiqh" },
        { val: "Kitabul Buyoo", text: "Fiqh - Kitabul Buyoo" }        
    ]
};

const levelSelect = document.getElementById('targetLevel');
const subjectSelect = document.getElementById('noteSubject');

levelSelect.addEventListener('change', () => {
    const selectedLevel = levelSelect.value;
    const subjects = subjectsByLevel[selectedLevel] || [];
    
    // Clear old options
    subjectSelect.innerHTML = '<option value="" disabled selected>Choose a subject</option>';
    
    // Add new options
    subjects.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub.val;
        opt.textContent = sub.text;
        subjectSelect.appendChild(opt);
    });
});


// --- THEME TOGGLE SCRIPT ---
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');

const applyTheme = (theme) => {
    document.documentElement.setAttribute('data-theme', theme);
    themeIcon.innerText = theme === 'dark' ? 'light_mode' : 'dark_mode';
    localStorage.setItem('theme', theme);
};

themeToggle.addEventListener('click', () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    applyTheme(isDark ? 'light' : 'dark');
});

// Load saved theme on startup
applyTheme(localStorage.getItem('theme') || 'light');


let currentUser = null;
onAuthStateChanged(auth, (user) => {
    currentUser = user;
});

const uploadForm = document.getElementById('uploadForm');

if (uploadForm) {
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        if(!currentUser) {
            alert("Login first!");
            window.location.href = "login.html";
            return;
        }

        const file = document.getElementById('noteFile').files[0];
        const title = document.getElementById('noteTitle').value;
        const subject = document.getElementById('noteSubject').value;
        const className = document.getElementById('className').value;
        const level = document.getElementById('targetLevel').value;
        
        const submitBtn = document.getElementById('uploadBtn');
        const pBar = document.getElementById('uploadProgress');
        const progressContainer = document.getElementById('progressContainer');
        const percentText = document.getElementById('percentText');
        
        submitBtn.disabled = true;
        submitBtn.innerText = "Starting Upload...";

        const storageRef = ref(storage, 'notes/' + Date.now() + "_" + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressContainer.style.display = 'block';
                pBar.value = progress;
                percentText.innerText = Math.round(progress) + "%";
                submitBtn.innerText = "Uploading: " + Math.round(progress) + "%";
            }, 
            (error) => {
                alert("Upload failed: " + error.message);
                submitBtn.disabled = false;
                submitBtn.innerText = "Upload to Cloud";
            }, 
            () => {
                getDownloadURL(uploadTask.snapshot.ref).then(async (url) => {
                    try {
                        await addDoc(collection(db, "notes"), {
                            title: title,
                            subject: subject,
                            className: className,
                            level: parseInt(level),
                            fileUrl: url,
                            uploaderName: currentUser.displayName || "Admin",
                            uploaderEmail: currentUser.email,
                            createdAt: serverTimestamp()
                        });
                        
                        submitBtn.innerText = "Uploaded! Redirecting...";
                        alert("Alhamdulillah! Level " + level + " Notes have been uploaded.");
                        
                        setTimeout(() => {
                            window.location.href = "explore-notes.html";
                        }, 800);
                        
                    } catch (dbError) {
                        alert("Database error: " + dbError.message);
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Upload to Cloud";
                    }
                });
            }
        );
    });
}
</script>

</body>
</html>